// --- UBAH DUA FUNCTION INI SAHAJA ---

function getQuotaStatus() {
  var ws = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Data");
  var data = ws.getDataRange().getValues();
  var lelaki = 0, perempuan = 0, limit = 30; // Limit kuota
  
  // Mula loop dari row 1 (row 0 adalah header)
  for (var i = 1; i < data.length; i++) {
    // Column index 6 = G (Jantina)
    if (data[i][6] === "Lelaki") lelaki++;
    if (data[i][6] === "Perempuan") perempuan++;
  }
  return { 
    lelakiFull: lelaki >= limit, 
    perempuanFull: perempuan >= limit, 
    lelakiCount: lelaki, 
    perempuanCount: perempuan 
  };
}

function processForm(data) {
  var lock = LockService.getScriptLock();
  try {
    lock.waitLock(30000); 
  } catch (e) {
    return { status: "error", message: "Server sibuk. Sila cuba sebentar lagi." };
  }

  try {
    var ws = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Data");
    var timestamp = new Date();
    
    // 1. FINAL CHECK KUOTA (BACKEND VALIDATION)
    // Ini penting supaya user tak boleh submit walau frontend dah disable
    var currentQuota = getQuotaStatus();
    var jantinaCheck = data.jantina1; 
    
    if (jantinaCheck === "Lelaki" && currentQuota.lelakiFull) {
       throw new Error("Maaf! Kuota Lelaki baru sahaja PENUH sebentar tadi.");
    }
    if (jantinaCheck === "Perempuan" && currentQuota.perempuanFull) {
       throw new Error("Maaf! Kuota Perempuan baru sahaja PENUH sebentar tadi.");
    }

    // 2. Handle File Upload
    var fileLinks = [];
    var folder = DriveApp.getFolderById(FOLDER_ID); 

    if (data.filesData && data.filesData.length > 0) {
      data.filesData.forEach(function(file) {
        var blob = Utilities.newBlob(Utilities.base64Decode(file.data.split(',')[1]), file.mimeType, file.name);
        var createdFile = folder.createFile(blob);
        fileLinks.push(createdFile.getUrl());
      });
    }

    var linkStr = fileLinks.length > 0 ? fileLinks.join(",\n") : "-";
    var jenis = data.jenisDaftar;
    var teamName = data.namaPasukan || "-";
    
    // 3. Masukkan Peserta 1 (Ketua)
    ws.appendRow([
      timestamp, jenis, teamName, 
      data.nama1, "'" + data.ic1, "'" + data.tel1, 
      data.jantina1, data.umur1, data.cawangan1, 
      data.alamat1, data.jenisBayaran, linkStr
    ]);

    // 4. Masukkan Ahli Team (Looping sampai 6)
    if (jenis === "Berkumpulan") {
      // Loop dari 2 hingga 6 (sekarang squad 6 orang)
      for (var i = 2; i <= 6; i++) {
        if (data["nama" + i] && data["nama" + i].toString().trim() !== "") {
          ws.appendRow([
            timestamp, jenis, teamName, 
            data["nama" + i], "'" + data["ic" + i], "'" + data["tel" + i], 
            data["jantina" + i], data["umur" + i], data["cawangan" + i], 
            data["alamat" + i], "Team Member", "Rujuk Ketua"
          ]);
        }
      }
    }
    
    return { status: "success" };

  } catch (error) {
    return { status: "error", message: error.toString() };
  } finally {
    lock.releaseLock();
  }
}
